name: Deploy to Dev Repo

on:
    push:
        branches:
            - dev

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout main repo
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  persist-credentials: false

            - name: Transform to Dev version
              run: |
                  # --- 1. Modifications to manifest.json ---
                  sed -i 's/"domain": "watchman"/"domain": "watchman_dev"/' custom_components/watchman/manifest.json
                  sed -i 's/"name":.*,/"name": "Watchman (DEV)",/' custom_components/watchman/manifest.json

                  # --- 2. Modifications to const.py ---
                  sed -i 's/DB_FILENAME = "watchman.db"/DB_FILENAME = "watchman_dev.db"/' custom_components/watchman/const.py
                  sed -i 's/DOMAIN = "watchman"/DOMAIN = "watchman_dev"/' custom_components/watchman/const.py

                  # --- 3. Rename the folder ---
                  mv custom_components/watchman custom_components/watchman_dev

            - name: Push to Dev Repository (Manual Force)
              env:
                  # Pass the token as an environment variable
                  TARGET_TOKEN: ${{ secrets.DEV_REPO_TOKEN }}
              run: |
                  # 1. Configure git (required for the commit)
                  git config --global user.name "Deploy Action"
                  git config --global user.email "action@github.com"

                  # 2. Commit our changes (renamed folders and files) to local history
                  git add .
                  git commit -m "Auto-deploy DEV version"

                  # 3. Direct push to the target repository
                  # We inject the token directly into the URL. This guarantees the token is used.
                  # HEAD:main means "take the current state and force write it to the main branch"
                  git push https://dummylabs:$TARGET_TOKEN@github.com/dummylabs/thewatchman_dev.git HEAD:main --force
